---
name: Docs - Update Wiki Variables

'on':
  push:
    branches:
      - release/v0.1.0  # TODO: Switch to 'main' after v0.1.0 release
    paths:
      - 'cli/modules/*/spec_*.py'
      - 'cli/modules/*/__init__.py'
      - '.github/scripts/generate_wiki_docs.py'
      - '.github/workflows/docs-update-wiki-variables.yaml'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  update-wiki:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Checkout wiki repository
        uses: actions/checkout@v5
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki
          token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Detect wiki default branch
        id: wiki_branch
        run: |
          cd wiki
          BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "Wiki default branch: $BRANCH"

      - name: Initialize wiki if it doesn't exist
        run: |
          if [ ! -d "wiki/.git" ]; then
            echo "Wiki repository not found. Please enable the wiki in repository settings:"
            echo "1. Go to https://github.com/${{ github.repository }}/settings"
            echo "2. Enable 'Wikis' under Features"
            echo "3. Create the first page at https://github.com/${{ github.repository }}/wiki"
            echo "4. Re-run this workflow"
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Generate variable documentation
        run: |
          python3 .github/scripts/generate_wiki_docs.py wiki/

      - name: Check for changes
        id: changes
        working-directory: wiki
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in wiki documentation"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in wiki documentation"
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        working-directory: wiki
        env:
          WIKI_BRANCH: ${{ steps.wiki_branch.outputs.branch }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Auto-update variable documentation from schema changes"
          
          # Pull with rebase to handle any remote changes, then push
          git pull --rebase origin "$WIKI_BRANCH"
          git push origin "$WIKI_BRANCH"

      - name: Summary
        run: |
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "Wiki variable documentation updated successfully"
            echo "View at: https://github.com/${{ github.repository }}/wiki"
          else
            echo "No changes to wiki documentation"
          fi
