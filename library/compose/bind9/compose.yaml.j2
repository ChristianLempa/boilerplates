services:
  {{ service_name }}:
    image: docker.io/ubuntu/bind9:{{ bind9_version }}
    {#
      If not in swarm mode, check whether container_name is set and apply restart policy,
      else swarm mode handles restarts via deploy.restart_policy
    #}
    {% if not swarm_enabled %}
    restart: {{ restart_policy }}
    {% if container_name %}
    container_name: {{ container_name }}
    {% endif %}
    {% endif %}
    {#
      Set container hostname (BIND9 uses this for identification)
    #}
    {% if container_hostname %}
    hostname: {{ container_hostname }}
    {% endif %}
    {#
      Environment variables for BIND9 configuration
      - TZ: Timezone for proper log rotation
      - BIND9_USER: User to run BIND9 as
    #}
    environment:
      - TZ={{ container_timezone }}
      - BIND9_USER=bind
    {#
      Port mappings for DNS queries:
      - DNS ports: Port 53 TCP/UDP (always exposed for DNS queries)
      Note: Swarm mode uses 'host' mode for port publishing to avoid port conflicts
    #}
    ports:
      {% if swarm_enabled %}
      - target: 53
        published: 53
        protocol: tcp
        mode: host
      - target: 53
        published: 53
        protocol: udp
        mode: host
      {% else %}
      - "53:53/tcp"
      - "53:53/udp"
      {% endif %}
    {#
      Volume configuration for persistent data
      - When volume_mode is 'mount': bind mount from host path
      - When volume_mode is 'local', 'nfs', or empty: use docker-managed volumes
    #}
    volumes:
      {% if volume_mode == 'mount' %}
      - {{ volume_mount_path }}/config:/etc/bind:rw
      - {{ volume_mount_path }}/zones:/var/lib/bind:rw
      - {{ volume_mount_path }}/cache:/var/cache/bind:rw
      {% else %}
      - {{ service_name }}-config:/etc/bind
      - {{ service_name }}-zones:/var/lib/bind
      - {{ service_name }}-cache:/var/cache/bind
      {% endif %}
    {#
      Deploy configuration for Swarm mode:
      - Single replica with node placement constraint (BIND9 doesn't support multi-replica)
      - Multiple instances would conflict with DNS services
    #}
    {% if swarm_enabled %}
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.hostname == {{ swarm_placement_host }}
      restart_policy:
        condition: on-failure
    {% endif %}

{#
  Volume definitions:
  - When volume_mode is 'local' (default): use docker-managed local volumes
  - When volume_mode is 'nfs': configure NFS-backed volumes
  - When volume_mode is 'mount': no volume definition needed (bind mounts used directly)
#}
{% if volume_mode == 'local' %}
volumes:
  {{ service_name }}-config:
    driver: local
  {{ service_name }}-zones:
    driver: local
  {{ service_name }}-cache:
    driver: local
{% elif volume_mode == 'nfs' %}
volumes:
  {{ service_name }}-config:
    driver: local
    driver_opts:
      type: nfs
      o: addr={{ volume_nfs_server }},{{ volume_nfs_options }}
      device: ":{{ volume_nfs_path }}/config"
  {{ service_name }}-zones:
    driver: local
    driver_opts:
      type: nfs
      o: addr={{ volume_nfs_server }},{{ volume_nfs_options }}
      device: ":{{ volume_nfs_path }}/zones"
  {{ service_name }}-cache:
    driver: local
    driver_opts:
      type: nfs
      o: addr={{ volume_nfs_server }},{{ volume_nfs_options }}
      device: ":{{ volume_nfs_path }}/cache"
{% endif %}

