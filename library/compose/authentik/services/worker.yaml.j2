{#
  Authentik Worker: Background task processor
  Handles long-running tasks like email sending, cleanup jobs, and scheduled tasks
#}
services:
  {{ service_name }}-worker:
    image: ghcr.io/goauthentik/server:2025.10.1
    {% if not swarm_enabled %}
    restart: {{ restart_policy }}
    container_name: {{ service_name }}-worker
    {% endif %}
    command: worker
    environment:
      - TZ={{ container_timezone }}
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
      - AUTHENTIK_ERROR_REPORTING__ENABLED={{ authentik_error_reporting }}
      - AUTHENTIK_REDIS__HOST={{ service_name }}-redis
      - AUTHENTIK_POSTGRESQL__HOST={{ service_name }}-postgres
      - AUTHENTIK_POSTGRESQL__USER={{ database_user }}
      - AUTHENTIK_POSTGRESQL__NAME={{ database_name }}
      - AUTHENTIK_POSTGRESQL__PASSWORD=${DATABASE_PASSWORD}
      {% if email_enabled %}
      - AUTHENTIK_EMAIL__HOST={{ email_host }}
      - AUTHENTIK_EMAIL__PORT={{ email_port }}
      - AUTHENTIK_EMAIL__USERNAME={{ email_username }}
      - AUTHENTIK_EMAIL__PASSWORD=${EMAIL_PASSWORD}
      {% if email_encryption == "starttls" %}
      - AUTHENTIK_EMAIL__USE_TLS=true
      {% elif email_encryption == "ssl" %}
      - AUTHENTIK_EMAIL__USE_SSL=true
      {% endif %}
      - AUTHENTIK_EMAIL__FROM={{ email_from }}
      {% endif %}
    user: root
    volumes:
      - /run/docker.sock:/run/docker.sock
      {% if volume_mode == 'mount' %}
      - {{ volume_mount_path }}/media:/media
      - {{ volume_mount_path }}/certs:/certs
      - {{ volume_mount_path }}/templates:/templates
      {% elif volume_mode in ['local', 'nfs'] %}
      - {{ service_name }}-media:/media
      - {{ service_name }}-certs:/certs
      - {{ service_name }}-templates:/templates
      {% endif %}
    depends_on:
      - {{ service_name }}-postgres
      - {{ service_name }}-redis
