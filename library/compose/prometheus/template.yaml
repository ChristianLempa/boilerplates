---
kind: compose
schema: "1.1"
metadata:
  name: Prometheus
  description: |
    Prometheus is an open-source systems monitoring and alerting toolkit originally built at SoundCloud.
    It is designed for reliability and scalability, making it suitable for monitoring dynamic cloud environments.
    Prometheus collects and stores metrics as time series data, providing powerful querying capabilities and integration with various visualization tools.

    ##  Swarm Deployment Warning
    Prometheus uses local TSDB storage and does NOT support running multiple replicas.
    This template enforces a single replica with node placement constraints. For true HA, consider remote storage solutions (Thanos, Cortex, VictoriaMetrics).

    Project: https://prometheus.io/

    Documentation: https://prometheus.io/docs/

    GitHub: https://github.com/prometheus/prometheus
  version: v3.7.3
  author: Christian Lempa
  date: '2025-10-31'
  tags:
    - traefik
    - swarm
  next_steps: |
    {% if swarm_enabled -%}
    1. Deploy to Docker Swarm:
       docker stack deploy -c compose.yaml {{ service_name }}
    2. Access Prometheus:
       {%- if traefik_enabled %} https://{{ traefik_host }}
       {%- else %} http://<swarm-node-ip>:{{ ports_http }}{%- endif %}
    {% else -%}
    1. Start Prometheus with Docker Compose:
       docker compose up -d
    2. Access Prometheus:
       {%- if traefik_enabled %} https://{{ traefik_host }}
       {%- else %} http://localhost:{{ ports_http }}{%- endif %}
    {% endif -%}
    3. Edit config/prometheus.yaml to add scrape targets
    4. Reload configuration: docker exec {{ container_name if not swarm_enabled else service_name }} kill -HUP 1
spec:
  general:
    vars:
      service_name:
        default: "prometheus"
      container_name:
        default: "prometheus"
      container_hostname:
        default: "prometheus"
  metrics:
    title: "Metrics & Storage"
    description: "Configure data retention and storage settings"
    vars:
      metrics_retention_time:
        type: str
        description: "How long to retain samples (e.g., 15d, 30d, 1y)"
        default: "15d"
        extra: "Older data will be deleted. Use 'h', 'd', 'w', 'y' for time units."
      metrics_retention_size:
        type: str
        description: "Maximum storage size (e.g., 5GB, 10GB, 1TB)"
        default: "0"
        extra: "Set to 0 for unlimited. Triggers deletion when exceeded."
      metrics_web_external_url:
        type: str
        description: "External URL for generating links (optional)"
        default: ""
        extra: "Use if behind reverse proxy, e.g., https://prometheus.example.com"
  ports:
    vars:
      ports_http:
        description: "External HTTP port for web UI and API"
        type: int
        default: 9090
        needs: ["traefik_enabled=false", "network_mode=bridge"]
  network:
    vars:
      network_mode:
        extra: "For Swarm, only 'bridge' is supported. Use bridge for Traefik integration."
      network_name:
        default: "prometheus_network"
  traefik:
    vars:
      traefik_enabled:
        needs: "network_mode=bridge"
      traefik_host:
        default: "prometheus.home.arpa"
      traefik_network:
        type: str
        description: "Traefik network name"
        default: "traefik"
        needs: "traefik_enabled"
      traefik_network_external:
        type: bool
        description: "Use external Traefik network"
        default: true
        needs: "traefik_enabled"
  swarm:
    vars:
      swarm_enabled:
        needs: "network_mode=bridge"
      swarm_placement_host:
        description: "Hostname of the node to deploy Prometheus on"
        required: true
        optional: false
        needs: null
        extra: "REQUIRED: Prometheus requires persistent storage on a single node"
