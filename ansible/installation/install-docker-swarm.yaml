---
- name: Install Docker and Docker Compose
  hosts: dev_docker_swarm_manager:dev_docker_swarm_worker
  become: yes  # To run tasks as root

  tasks:
    - name: Update apt package cache (for Debian/Ubuntu)
      apt:
        update_cache: yes
      when: ansible_os_family == "Debian" or ansible_os_family == "Ubuntu"

    - name: Install required packages
      package:
        name: 
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
          - docker.io
          - docker-compose
        state: present
      when: ansible_os_family == "Debian" or ansible_os_family == "Ubuntu"

- name: Initialize Docker Swarm and Get Join Token
  hosts: dev_docker_swarm_manager
  become: yes  # To run tasks as root

  tasks:
    - name: Check if Docker Swarm is already initialized
      command: docker info --format '{{.Swarm.LocalNodeState}}'
      register: swarm_status
      changed_when: false  # Treat this task as non-changing

    - name: Initialize Docker Swarm
      command: docker swarm init
      when: swarm_status.stdout != "active"

    - name: Extract Join Token for Workers
      set_fact:
        join_worker_command: "{{ lookup('pipe', 'docker swarm join-token worker') }}"
      when: swarm_status.stdout == "active"

    - name: Print Join Token for Workers
      debug:
        msg: "Join token for worker nodes: {{ join_worker_command }}"
      when: swarm_status.stdout == "active"
