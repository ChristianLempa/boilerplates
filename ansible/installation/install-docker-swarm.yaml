---
- name: Initialisation d'un cluster Docker Swarm
  hosts: dev_docker_swarm_manager  # Remplacez ceci par le groupe d'hôtes de gestionnaires Swarm
  become: yes

  tasks:
    - name: Initialisation du Swarm
      docker_swarm:
        state: present
      register: swarm_initialized

    - name: Récupération du token de travailleur
      debug:
        var: swarm_initialized.swarm_facts.JoinTokens.Worker

- name: Rejoindre le cluster Swarm en tant que travailleur
  hosts: dev_docker_swarm_worker  # Remplacez ceci par le groupe d'hôtes de travailleurs Swarm
  become: yes

  tasks:
    - name: Rejoindre le cluster Swarm en tant que travailleur
      docker_swarm:
        state: joined
        join_token: 
          {% for host in groups['dev_docker_swarm_manager'] %}
            "{{ hostvars['host'].swarm_initialized.swarm_facts.JoinTokens.Worker }}"
          {% endfor %}
        manager_address: 
          {% for host in groups['dev_docker_swarm_manager'] %}
            "{{ hostvars['host'].inventory_hostname }}"
          {% endfor %}
